<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Visão – Roboflow</title>
  <style>
    body{font-family:system-ui,Arial,sans-serif;max-width:1100px;margin:20px auto;padding:0 12px}
    canvas,video{max-width:100%;border:1px solid #ddd;border-radius:8px}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    button{padding:8px 12px;border-radius:10px;border:1px solid #333;background:#111;color:#fff}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;background:#eee}
  </style>
</head>
<body>
  <h1>Visão Computacional – Roboflow</h1>
  <div class="row">
    <button id="start">▶️ Start Webcam</button>
    <span>FPS: <b id="fps" class="pill">0</b></span>
    <span>Detecções: <b id="det" class="pill">0</b></span>
  </div>
  <div class="row" style="margin-top:8px">
    <video id="video" width="640" height="360" autoplay muted playsinline></video>
    <canvas id="canvas" width="640" height="360"></canvas>
  </div>

  <script>
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const fpsEl = document.getElementById('fps');
    const detEl = document.getElementById('det');

    // 3 zonas retangulares (ajuste conforme seu layout)
    const zones = {
      Z1: {x:10,y:10,w:200,h:340},
      Z2: {x:220,y:10,w:200,h:340},
      Z3: {x:430,y:10,w:200,h:340}
    };

    function zoneOfBox(b){
      const cx = b.x + b.width/2, cy = b.y + b.height/2;
      for (const [id,z] of Object.entries(zones)){
        if (cx>=z.x && cx<=z.x+z.w && cy>=z.y && cy<=z.y+z.h) return id;
      }
      return null;
    }

    let lastTs = performance.now();

    async function loop(){
      if (video.readyState >= 2){
        ctx.drawImage(video,0,0,canvas.width,canvas.height);
        const dataUrl = canvas.toDataURL('image/jpeg', 0.7);

        const r = await fetch('/vc/detect',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({imageBase64: dataUrl})});
        const j = await r.json();

        let detections = 0;
        if (j && j.predictions){
          detections = j.predictions.length;
          ctx.strokeStyle = '#00ff00'; ctx.lineWidth = 2;
          for (const p of j.predictions){
            const x = p.x - p.width/2, y = p.y - p.height/2, w = p.width, h = p.height;
            ctx.strokeRect(x,y,w,h);
            ctx.fillStyle = 'rgba(0,0,0,.6)';
            ctx.fillRect(x,y-18,Math.max(60,ctx.measureText(p.class).width+10),18);
            ctx.fillStyle = '#fff';
            ctx.fillText(`${p.class} ${(p.confidence*100).toFixed(0)}%`, x+4, y-5);

            // Reenvia como evento para o backend (reuso das regras de alerta)
            const z = zoneOfBox({x,y,width:w,height:h});
            fetch('/ingest',{
              method:'POST', headers:{'Content-Type':'application/json'},
              body: JSON.stringify({
                device_id: `vc-${z||'NA'}`,
                type: 'rfid',
                zone_id: z,
                ts_device: Date.now(),
                payload: { plate: `VIS-${Math.floor(p.x)}-${Math.floor(p.y)}`, confidence: p.confidence }
              })
            });
          }
        }
        detEl.textContent = detections;

        // FPS
        const now = performance.now(); const dt = now - lastTs; lastTs = now;
        fpsEl.textContent = (1000/dt).toFixed(1);

        // Desenha regiões das zonas
        ctx.strokeStyle = '#0077ff'; ctx.lineWidth = 1.5;
        for (const z of Object.values(zones)) ctx.strokeRect(z.x,z.y,z.w,z.h);
      }
      requestAnimationFrame(loop);
    }

    document.getElementById('start').onclick = async () => {
      const stream = await navigator.mediaDevices.getUserMedia({video:true});
      video.srcObject = stream;
      loop();
    };
  </script>
</body>
</html>
